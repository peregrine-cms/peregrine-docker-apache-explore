<VirtualHost *:80>

    Protocols h2 http/1.1

    ModPagespeed unplugged
    ModPagespeedEnableCachePurge on
    ModPagespeedPurgeMethod PURGE
    ModPagespeedEnableFilters inline_javascript
    ModPagespeedJsInlineMaxBytes 1000000
    ModPagespeedCssInlineMaxBytes 16000
    ModPagespeedEnableFilters inline_css

    SetOutputFilter DEFLATE
    ExpiresActive   On
    ExpiresByType   image/jpeg "access plus 1 year"
    ExpiresByType   image/png "access plus 1 year"
    ExpiresDefault  "access plus 1 month"

    ServerAdmin webmaster@${APACHE_DOMAIN}
    DocumentRoot "/var/www/html"
    ServerName ${APACHE_DOMAIN}
    ErrorLog "${APACHE_LOG_DIR}/${APACHE_DOMAIN}-error_log"
    CustomLog "${APACHE_LOG_DIR}/${APACHE_DOMAIN}-access_log" common

    <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    ErrorDocument 404 /content/${PEREGRINE_SITE}/pages/errors/404.html

    RewriteEngine On

    # Force HTTPS on load balancers
    RewriteCond %{HTTP:X-Forwarded-Proto} =http
    RewriteRule . https://%{SERVER_NAME}%{REQUEST_URI} [L,R=permanent]

    # Block URIs
    RewriteCond %{REQUEST_URI} ^(/bin|/system).*$ [NC,OR]
    RewriteCond %{REQUEST_URI} ^(/perapi/admin|/content/admin).*$ [NC]
    RewriteRule ^ - [R=404,NC,L]

    # Prevent HTTP methods that change the state of the server
    RewriteCond %{REQUEST_METHOD} ^(DELETE|POST|PUT)$ [NC]
    RewriteRule ^ - [R=403,NC,L]

    # Add support for robots.txt at root of site
    RewriteRule "^/robots.txt$" /content/${PEREGRINE_SITE}/pages/robots.txt [PT]

    Add support for service worker at root of site
    RewriteRule "^/serviceworker.js$" /content/${PEREGRINE_SITE}/pages/serviceworker.js [PT]

    # Redirect to home page
    RewriteRule "^/$" /content/${PEREGRINE_SITE}/pages/index.html [PT,L]
    RewriteRule "^/content/${PEREGRINE_SITE}$" /content/${PEREGRINE_SITE}/pages/index.html [PT,L]

    # Handle short URLs
    RewriteCond %{REQUEST_URI} !/content/.*
    RewriteRule "^(.*)\.html$" /content/${PEREGRINE_SITE}/pages$1.html [PT]

    # Handle sitemap
    RewriteRule ^/sitemap.xml$ /content/${PEREGRINE_SITE}/pages.sitemap.xml [PT,L]

    ProxyRequests Off
    ProxyPreserveHost On
    ProxyErrorOverride On

    ProxyPass          /       ${APACHE_PROXY_URL}
    ProxyPassReverse   /       ${APACHE_PROXY_URL}

</VirtualHost>
