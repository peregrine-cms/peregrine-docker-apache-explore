<VirtualHost *:80>

    Protocols h2 http/1.1

    ModPagespeed unplugged

    SetOutputFilter DEFLATE

    ServerAdmin webmaster@${APACHE_DOMAIN}
    DocumentRoot "/var/www/html"
    ServerName ${APACHE_DOMAIN}
    ErrorLog "${APACHE_LOG_DIR}/${APACHE_DOMAIN}-error_log"
    CustomLog "${APACHE_LOG_DIR}/${APACHE_DOMAIN}-access_log" common

    <Directory /var/www/html>
        Options Indexes FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    OIDCProviderMetadataURL ${OIDC_PROVIDER_METADATA_URL}
    OIDCClientID            ${OIDC_CLIENT_ID}
    OIDCClientSecret        ${OIDC_CLIENT_SECRET}
    OIDCCryptoPassphrase    ${OIDC_CRYPTO_PASSPHRASE}
    OIDCScope               "openid"
    OIDCPassClaimsAs        both
    OIDCAuthNHeader         REMOTE_USER

    # OIDCRedirectURI is a URL that must point to a protected path (i.e. Location below),
    # but does not point to any content on the server or the proxy. Basically, you can name 
    # this URI whatever you like. It also needs to be ignored by the proxy pass (see below).
    OIDCRedirectURI         /oidc/redirect_uri

    # Allow health check requests to be unauthenticated
    <Location "/content/sites/themecleanflex/index.html">
      Order deny,allow
      Allow from all
      Satisfy any
    </Location>

    <Location />
       AuthType openid-connect
       Require valid-user
    </Location>

    # Force HTTPS on load balancers
    RewriteEngine On
    RewriteCond %{HTTP:X-Forwarded-Proto} =http
    RewriteRule . https://%{SERVER_NAME}%{REQUEST_URI} [L,R=permanent]

    ProxyRequests Off
    ProxyPreserveHost On

    ProxyPass          /       ${APACHE_PROXY_URL}
    ProxyPassReverse   /       ${APACHE_PROXY_URL}

    ProxyPass "/oidc/redirect_uri" !

</VirtualHost>
